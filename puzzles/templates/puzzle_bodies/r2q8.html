{% extends "puzzle.html" %}
{% block puzzle-body-md %}

<div class="notice_info">
    你可能需要的参考资料：<a href="/static/puzzle_resources/r2q8/dictionary.txt">字典</a>
</div>

<div class="notice_info">
    本题有中间答案验证。
</div>

达成BINGO领取奖金！如果同时满足额外条件更有超级大奖哦~
{: .flavor}





<div style="display: flex">
    <div style="width:65%; margin-right: 24px">
        <!-- 提交按钮 -->
        <div align="center">
            <form id="r2q8-form" autocomplete="off" action="javascript:void(0);">
                {% csrf_token %}
                <input type="text" name="wordInput" id="wordInput" placeholder="请输入" style="width: 70%;">
                <input type="submit" value="提交">
            </form>
        </div>
        
        <!-- 提示信息 -->
        <div id="output" align="center"></div>

        <!-- 格子 -->
        <div id="grids" align="center"></div>
        

        <!-- 暗箱操作 -->
        <div align="center" id="spoiler_div" style="margin: 0 10%;">
            <form id="r2q8-do_spoil" autocomplete="off" action="javascript:void(0);">
                {% csrf_token %}
                <input type="submit" value="暗箱操作 花费50金">
            </form>
        </div>

        <!-- 当前金币 -->
        <div align="center" id="current_gold">
            <p> 你当前拥有 {{team.puzzle_bingo_game_data.bingo_coin_num}} 金</p>
        </div>

    </div>

    <!-- 历史记录 -->
    {% if team %}
    <div style="width: 35%; margin-left: 24px;">
        <h5 class="modal-title" id="modalLabel">历史记录（最近100条）</h5>
        <ol>
            {% for word in team.puzzle_bingo_game_data.word_history %}
                <li>{{ word }}</li>
            {% endfor %}
        </ol>
    </div>
    {% endif %}
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>


<script type="text/javascript">
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    function create_base_block(id) {
        const square = document.createElement('div');
        square.id = id;
        square.style.width = '50px';
        square.style.height = '50px';
        square.style.backgroundColor = 'black';
        square.style.color = 'white';
        square.style.display = 'flex';
        square.style.alignItems = 'center';
        square.style.justifyContent = 'center';
        square.style.fontSize = '12px';
        square.style.border = '2px solid black';
        return square;
    }
    function create_index_block(index) {
        const square = document.createElement('div');
        square.style.width = '50px';
        square.style.height = '50px';
        // square.style.backgroundColor = 'white';
        square.style.color = 'black';
        square.style.display = 'flex';
        square.style.alignItems = 'center';
        square.style.justifyContent = 'center';
        square.style.fontSize = '20px';
        square.textContent = `${index}`;
        return square;
    }

    function create_base_page() {
        const known_rules = Object.entries({{ team.puzzle_bingo_game_data.known_rules|safe }});
        // Create 2 containers for the grid
        const grid_container_5_5 = document.createElement('div');
        const grid_container_1_2 = document.createElement('div');
        for (const container of [grid_container_5_5, grid_container_1_2]) {
            container.style.display = 'grid';
            container.style.gap = '10px';
            container.style.margin = '24px auto';
            container.style.width = 'fit-content';
            container.style.fontSize = '100%';
            container.style.lineHeight = '80%';
        }
        grid_container_5_5.style.gridTemplateRows = 'repeat(6, 50px)'; // 5 rows
        grid_container_5_5.style.gridTemplateColumns = 'repeat(7, 50px)'; // 5 columns
        grid_container_1_2.style.gridTemplateRows = 'repeat(1, 50px)'; // 1 rows
        grid_container_1_2.style.gridTemplateColumns = 'repeat(2, 50px)'; // 2 columns
    
        // Fill the grids
        for (let i = 0; i < 27; i++) {
            if (i == 0) {
                grid_container_5_5.appendChild(create_index_block(1));
                grid_container_5_5.appendChild(create_index_block(2));
                grid_container_5_5.appendChild(create_index_block(8));
                grid_container_5_5.appendChild(create_index_block(3));
                grid_container_5_5.appendChild(create_index_block(4));
                grid_container_5_5.appendChild(create_index_block(9));
                grid_container_5_5.appendChild(create_index_block(12));
                grid_container_5_5.appendChild(create_index_block(6));
            }
            if (i == 5) {
                grid_container_5_5.appendChild(create_index_block(''));
                grid_container_5_5.appendChild(create_index_block(10));
            }
            if (i == 10) {
                grid_container_5_5.appendChild(create_index_block(''));
                grid_container_5_5.appendChild(create_index_block(7));
            }
            if (i == 15) {
                grid_container_5_5.appendChild(create_index_block(''));
                grid_container_5_5.appendChild(create_index_block(5));
            }
            if (i == 20) {
                grid_container_5_5.appendChild(create_index_block(''));
                grid_container_5_5.appendChild(create_index_block(11));
            }
            const square = create_base_block(i);
            // For known rules, tick it and hover to show rule content
            const is_known = known_rules.find(([key]) => parseInt(key) === i);
            if (is_known) {
                const ruleContent = known_rules.find(([key]) => parseInt(key) === i)[1]
                square.textContent = '\u2714';  // unicode tick symbol
                square.addEventListener('mouseover', () => {
                    square.textContent = ruleContent;
                });

                square.addEventListener('mouseout', () => {
                    square.textContent = '\u2714';
                });
            // For unknown rules, allow buy_a_sample
            } else {
                square.addEventListener('mouseover', () => {
                    square.textContent = '随机示例 花费1金';
                });
                square.addEventListener('click', () => {
                    buy_a_sample(i);
                });
                square.addEventListener('mouseout', () => {
                    square.textContent = '';
                });
            }
            // Put into corresponidng container box
            if (i < 25) {
                grid_container_5_5.appendChild(square);
            } else {
                grid_container_1_2.appendChild(square);
            }
        }
        // Put into div
        const gridsDiv = document.getElementById('grids');
        gridsDiv.innerHTML = ''; // Clear previous content
        gridsDiv.appendChild(grid_container_5_5);
        gridsDiv.appendChild(grid_container_1_2);

        // a little hack: json boolean false -> string 'False'
        const spoil_text = `{{ team.puzzle_bingo_game_data.bingo_spoiled|safe }}`;
        if (spoil_text != '') {
            $(`#spoiler_div`).html(`
                <p>${spoil_text}</p>
            `);
        }
    }


    async function guess_a_word() {
        const wordInput = document.getElementById('wordInput');
        const outputDiv = document.getElementById('output');

        // 禁用输入框和按钮
        wordInput.disabled = true;

        let csrftoken = getCookie('csrftoken');
        try {
            let result = await fetch("/puzzle/r2q8/submit", {
                method: 'POST',
                body: JSON.stringify({
                    mode: "guess_a_word",
                    word: wordInput.value,
                }),
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken,
                },
            });

            create_base_page();
            
            if (!result.ok) {
                outputDiv.textContent = `Error: ${result.status} ${result.statusText}`;
            } else {
                let res = await result.json();
                if (res.error) {
                    outputDiv.textContent = `${res.error}`;
                } else {
                    if (res.triggered_rules) {
                        outputDiv.textContent = '';
                        for (let i = 0; i < 27; i++) {
                            // For triggered rules, reverse it color and bg-color
                            const is_triggered = Object.entries(res.triggered_rules).find(([key]) => parseInt(key) === i);
                            if (is_triggered) {
                                $(`#${i}`).css({
                                    backgroundColor: 'white',
                                    color: 'black'
                                });
                            }
                        }
                    } else {
                        outputDiv.textContent = '发生未知错误，请联系管理员。';
                    }
                }
            }
        } catch (e) {
            outputDiv.textContent = '发生未知错误，请联系管理员。'
        }

        // 启用输入框和按钮
        wordInput.disabled = false;
    }

    async function do_spoil() {
        const outputDiv = document.getElementById('output');

        let csrftoken = getCookie('csrftoken');
        try {
            let result = await fetch("/puzzle/r2q8/submit", {
                method: 'POST',
                body: JSON.stringify({
                    mode: "do_spoil",
                }),
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken,
                },
            });
            
            create_base_page();

            if (!result.ok) {
                // 大概率是网络问题 ｜ outputDiv.textContent = '发生未知错误，请联系管理员。'
                outputDiv.textContent = `Error: ${result.status} ${result.statusText}`;
            } else {
                let res = await result.json();
                if (res.error) {
                    outputDiv.textContent = `${res.error}`;
                } else {
                    outputDiv.textContent = ``;
                }
            }
        } catch (e) {
            outputDiv.textContent = '发生未知错误，请联系管理员。'
        }

        // 启用输入框和按钮
        wordInput.disabled = false;
    }

    async function buy_a_sample(i) {
        const outputDiv = document.getElementById('output');
        
        let csrftoken = getCookie('csrftoken');
        try {
            let result = await fetch("/puzzle/r2q8/submit", {
                method: 'POST',
                body: JSON.stringify({
                    mode: "buy_a_sample",
                    rule_index: i
                }),
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken,
                },
            });

            create_base_page();

            if (!result.ok) {
                outputDiv.textContent = `Error: ${result.status} ${result.statusText}`;
            } else {
                let res = await result.json();
                if (res.error) {
                    outputDiv.textContent = `${res.error}`;
                } else {
                    if (res.sample_word) {
                        outputDiv.textContent = `${res.sample_word}`;
                        console.log(`<p> 你当前拥有 ${res.bingo_coin_num} 金</p>`);
                        document.getElementById('current_gold').innerHTML = `<p> 你当前拥有 ${res.bingo_coin_num} 金</p>`;
                    } else {
                        outputDiv.textContent = '发生未知错误，请联系管理员。';
                    }
                }
            }
        } catch (e) {
            outputDiv.textContent = '发生未知错误，请联系管理员。'
        }
    }


    // This demo code uses jQuery and modern JavaScript features flagrantly.
    // You should evaluate your own needs.
    document.addEventListener('DOMContentLoaded', () => {
        create_base_page();
        


        
        $('#r2q8-form').on('submit', guess_a_word);
        $('#r2q8-do_spoil').on('submit', do_spoil);
        // TODO other submit function (buy_a_sample, do_spoil)
    });
</script>


<button class="btn clipboard-button"></button>

{% endblock %}
