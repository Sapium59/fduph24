{% load i18n %}
{% load puzzle_tags %}
{% load humanize %}
{% load static %}

<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no">
    {% block page-title %}
    <title>{{ hunt_title }}</title>
    {% endblock %}
    <!-- <meta name="viewport" content="width=device-width, initial-scale=0.5"> -->
    <meta property="og:title" content="FIXME">
    <meta property="og:description" content="{% blocktranslate with hunt=hunt_title%}Registration for this year's {{ hunt }} is now open!{% endblocktranslate %}">
    <meta property="og:image" content="{{ domain|slice:'-1' }}FIXME">
    <meta property="twitter:card" content="summary_large_image">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="{% static "css/skeleton.css" %}">
    <link rel="stylesheet" href="{% static "css/base.css" %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.touchswipe/1.6.19/jquery.touchSwipe.min.js"></script>
    <script src="{% url 'javascript-catalog' %}"></script>
    <script src="{% static "js/jquery.formset.js" %}"></script>
    <script src="{% static "js/sorttable.js" %}"></script>
    <script src="{% static "js/tray.js" %}"></script>
    <script src="{% static "js/notify.js" %}"></script>
    <script src="{% static "js/time.js" %}"></script>
    
    <!-- deprecated icon -->
    <!-- <link rel="icon" sizes="16x16 32x32 48x48 64x64" href="{% static "images/favicon.ico" %}" type="image/vnd.microsoft.icon"> -->
    <!-- tmp icon -->
    <!--<link rel="icon" sizes="16x16 32x32 48x48 64x64" href="{% static "/elearning_style/favicon.ico" %}" type="image/vnd.microsoft.icon">-->
    <!-- FIXME: we have a new icon from Lithium -->
    <link rel="icon" href="{% static "/images/logo.webp" %}">


    <!-- copied and modified form elearning -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#394B58">
    <meta name="robots" content="noindex,nofollow">

    <!-- original version of elearning downloadings, not suitable for production -->
    <!-- <link rel="stylesheet" href="./elearning_style/fonts-d8f4814aae.css" media="screen">
    <link rel="stylesheet" href="./elearning_style/variables-7dd4b80918af0e0218ec0229e4bd5873.css" media="all">
    <link rel="stylesheet" href="./elearning_style/common-56d52a60f7.css" media="all">
    <link rel="stylesheet" href="./elearning_style/context_list-e43e971339.css" media="screen">
    <link rel="stylesheet" href="./elearning_style/course_list-b33ee0ba11.css" media="screen">
    <link rel="stylesheet" href="./elearning_style/new_user_tutorials-9f099dbed9.css" media="screen">
    <link rel="icon" type="image/x-icon" href="./elearning_style/favicon.ico">
    <link rel="stylesheet" href="./elearning_style/overrides.css" media="all"> -->
    
    <!-- modifired version -->
    <!-- <link rel="stylesheet" href="{% static 'elearning_style/fonts.css' %}" media="screen"> -->
    
    <!-- NOTE: this common.css overwrites `content` class -->
    <!-- <link rel="stylesheet" href="{% static 'elearning_style/common.css' %}" media="screen"> -->
    
    <!-- WIP -->
    <!-- <link rel="stylesheet" href="./elearning_style/variables-7dd4b80918af0e0218ec0229e4bd5873.css" media="all">
    <link rel="stylesheet" href="./elearning_style/common.css" media="all">
    <link rel="stylesheet" href="./elearning_style/context_list-e43e971339.css" media="screen">
    <link rel="stylesheet" href="./elearning_style/course_list-b33ee0ba11.css" media="screen">
    <link rel="stylesheet" href="./elearning_style/new_user_tutorials-9f099dbed9.css" media="screen"> -->
    <!-- <link rel="icon" type="image/x-icon" href="./elearning_style/favicon.ico"> -->
    <!-- <link rel="stylesheet" href="./elearning_style/overrides.css" media="all"> -->

    <style type="text/css"></style>


    
    {{ ga_code|safe }}
</head>
<body>
     <div class="sidebar">
        <a href="{% url 'index' %}">
            <div style="background-color: #f9f8f5;">
                <img src="/static/images/logo.webp">
            </div>
        </a>
        <ul>
            {% if request.user.is_authenticated %}
                <a href="{% url 'logout' %}"> 
                    <div>登出</div> 
                </a>

                {% comment %} TODO: need review and test {% endcomment %}
                <li>
                    {% if team %}
                        <a class="team-name" href="{% url 'team' team.team_name %}">
                            <div>
                                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" xml:space="preserve" aria-labelledby="svgTitle">
                                    <circle cx="100" cy="60" r="40"></circle>
                                    <path d="M12.5,195.0l3.08,-17.04A85.58,85.58,0,0,1,100,108.33h0a85.58,85.58,0,0,1,84.17,70.67l3.08,17.04" stroke-width="2"></path>
                                </svg>
                            </div>
                            <div>
                                {{ request.user }}
                            </div>
                        </a>
                    {% else %}
                        {{ request.user }}
                    {% endif %}

                    {% if request.user.is_impersonate %}
                        <span class="current-stat" title="顶号中（慎用！）">
                            ({{ request.impersonator }}
                            <a style="padding: 0" href="{% url 'impersonate-stop' %}">&#x1F6D1;</a>)
                        </span>
                    {% endif %}

                    {% if team and num_hints_remaining > 0 %}
                        <span class="current-stat" title="可用提示余量： {{ num_hints_remaining }}">
                            {% include 'icon-hint.svg' %}
                            <span class="current-stat-label">{{ num_hints_remaining }}</span>
                        </span>
                    {% endif %}

                    {% if team and hunt_has_started %}
                        <span class="current-stat" title="Solves: {{ team.solves|length }}">
                            {% include 'icon-solve.svg' %}
                            <span class="current-stat-label">{{ team.solves|length }}</span>
                        </span>
                    {% endif %}
                </li>
            {% elif not hunt_is_closed %}
                <li>
                    <a href="{% url 'login' %}">
                        <div>
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" version="1.1" width="200px" height="200px" viewBox="0 0 24 24" fill="none" enable-background="new 0 0 24 24" xml:space="preserve">
                                <path d="M12 3.25C11.5858 3.25 11.25 3.58579 11.25 4C11.25 4.41421 11.5858 4.75 12 4.75C16.0041 4.75 19.25 7.99594 19.25 12C19.25 16.0041 16.0041 19.25 12 19.25C11.5858 19.25 11.25 19.5858 11.25 20C11.25 20.4142 11.5858 20.75 12 20.75C16.8325 20.75 20.75 16.8325 20.75 12C20.75 7.16751 16.8325 3.25 12 3.25Z"/>
                                <path d="M10.4697 9.53033C10.1768 9.23744 10.1768 8.76256 10.4697 8.46967C10.7626 8.17678 11.2374 8.17678 11.5303 8.46967L14.5303 11.4697C14.8232 11.7626 14.8232 12.2374 14.5303 12.5303L11.5303 15.5303C11.2374 15.8232 10.7626 15.8232 10.4697 15.5303C10.1768 15.2374 10.1768 14.7626 10.4697 14.4697L12.1893 12.75H4C3.58579 12.75 3.25 12.4142 3.25 12C3.25 11.5858 3.58579 11.25 4 11.25H12.1893L10.4697 9.53033Z"/>
                            </svg>
                        </div>
                        <div>
                            登陆
                        </div>
                    </a>
                </li>
            {% endif %}

            {% if story_page_visible %}
                <li>
                    <a href="{% url 'story' %}">
                        <div>
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0"y="0" viewBox="0 0 280 280" enable-background="new 0 0 280 280" xml:space="preserve">
                        <path
                        d="M197.07,213.38h16.31V197.07H197.07Zm-16.31,16.31V180.76h48.92v48.92Zm-48.92-16.31h16.31V197.07H131.85Zm-16.31,16.31V180.76h48.92v48.92ZM66.62,213.38H82.93V197.07H66.62ZM50.32,229.68V180.76H99.24v48.92Zm146.75-81.53h16.31V131.85H197.07Zm-16.31,16.31V115.54h48.92v48.92Zm-48.92-16.31h16.31V131.85H131.85Zm-16.31,16.31V115.54h48.92v48.92ZM66.62,148.15H82.93V131.85H66.62ZM50.32,164.46V115.54H99.24v48.92ZM34,262.29H246V82.93H34ZM246,66.62V42.16A8.17,8.17,0,0,0,237.84,34H213.38v8.15a8.15,8.15,0,1,1-16.31,0V34H82.93v8.15a8.15,8.15,0,0,1-16.31,0V34H42.16A8.17,8.17,0,0,0,34,42.16V66.62Zm-8.15-48.92a24.49,24.49,0,0,1,24.46,24.46V278.6H17.71V42.16A24.49,24.49,0,0,1,42.16,17.71H66.62V9.55a8.15,8.15,0,0,1,16.31,0v8.15H197.07V9.55a8.15,8.15,0,1,1,16.31,0v8.15Z">
                        </path>
                    </svg>
                    </div>
                    <div>
                        剧情
                    </div>
                    </a>
                </li>
            {% endif %}

            {% if hunt_has_started or hunt_has_almost_started %}
            <li>
                <a href="{% url 'puzzles' %}">
                    <div>
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0" y="0" viewBox="0 0 280 280" enable-background="new 0 0 280 280" xml:space="preserve">
                            <path d="M73.31,198c-11.93,0-22.22,8-24,18.73a26.67,26.67,0,0,0-.3,3.63v.3a22,22,0,0,0,5.44,14.65,22.47,22.47,0,0,0,17.22,8H200V228.19h-134V213.08H200V198Zm21-105.74h90.64V62H94.3ZM79.19,107.34V46.92H200v60.42Zm7.55,30.21V122.45H192.49v15.11ZM71.65,16.71A22.72,22.72,0,0,0,49,39.36V190.88a41.12,41.12,0,0,1,24.32-8h157V16.71ZM33.88,39.36A37.78,37.78,0,0,1,71.65,1.6H245.36V198H215.15v45.32h22.66V258.4H71.65a37.85,37.85,0,0,1-37.76-37.76Z">
                        </svg>
                    </div>
                    <div>
                        谜题列表
                    </div>
                </a>
            </li>
            {% endif %}

            <li>
                <a href="{% url 'teams' %}">
                    <div>
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0"y="0" viewBox="0 0 280 280" enable-background="new 0 0 280 280" xml:space="preserve">
                            <path d="M91.72,120.75h96.56V104.65H91.72Zm0,48.28h80.47V152.94H91.72Zm0-96.56h80.47V56.37H91.72Zm160.94,34.88H228.52V10.78h-177v96.56H27.34A24.17,24.17,0,0,0,3.2,131.48V244.14a24.17,24.17,0,0,0,24.14,24.14H252.66a24.17,24.17,0,0,0,24.14-24.14V131.48A24.17,24.17,0,0,0,252.66,107.34Zm0,16.09a8.06,8.06,0,0,1,8,8v51.77l-32.19,19.31V123.44ZM67.58,203.91v-177H212.42v177ZM27.34,123.44H51.48v79.13L19.29,183.26V131.48A8.06,8.06,0,0,1,27.34,123.44ZM252.66,252.19H27.34a8.06,8.06,0,0,1-8-8V202l30,18H230.75l30-18v42.12A8.06,8.06,0,0,1,252.66,252.19Z">
                    </svg>
                    </div>
                    <div>
                        团队列表
                    </div>
                </a>
            </li>

            <li>
                <a href="{% url 'about' %}">
                    <div>
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0" y="0" viewBox="0 0 200 200" enable-background="new 0 0 200 200" xml:space="preserve">
                            <path d="M100,10A90,90,0,1,0,100,190A90,90,0,1,0,100,10L100,20A80,80,0,1,1,100,180A80,80,0,1,1,100,20 M100,48 A12,12,0,1,0,100,72A12,12,0,1,0,100,48 M90,90L110,90L110,150L90,150L90,90"
                            transform="translate(-5.2 -5.2)"></path>
                        </svg>
                    </div>
                    <div>
                        活动介绍
                    </div>
                </a>
            </li>

            <li>
                <a href="{% url 'faq' %}">
                    <div>
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0" y="0" viewBox="0 0 200 200" enable-background="new 0 0 200 200" xml:space="preserve">
                            <path
                            d="M100,127.88A11.15,11.15,0,1,0,111.16,139,11.16,11.16,0,0,0,100,127.88Zm8.82-88.08a33.19,33.19,0,0,1,23.5,23.5,33.54,33.54,0,0,1-24,41.23,3.4,3.4,0,0,0-2.74,3.15v9.06H94.42v-9.06a14.57,14.57,0,0,1,11.13-14,22.43,22.43,0,0,0,13.66-10.27,22.73,22.73,0,0,0,2.31-17.37A21.92,21.92,0,0,0,106,50.59a22.67,22.67,0,0,0-19.68,3.88,22.18,22.18,0,0,0-8.65,17.64H66.54a33.25,33.25,0,0,1,13-26.47A33.72,33.72,0,0,1,108.82,39.8ZM100,5.2A94.8,94.8,0,1,0,194.8,100,94.91,94.91,0,0,0,100,5.2m0,178.45A83.65,83.65,0,1,1,183.65,100,83.73,83.73,0,0,1,100,183.65"
                            transform="translate(-5.2 -5.2)"></path>
                        </svg>
                    </div>
                    <div>
                        FAQ
                    </div>
                </a>
            </li>

            <li>
                <a href="{% url 'tools' %}">
                    <div>
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="80" height="80" transform="scale(-1, 1)">
                            <path d="M30.651,23.538l25.24,24.346l-6.577,6.577l-23.969,-25.617l5.306,-5.306Zm-7.208,3.403l5.306,-5.305c0,0 -2.695,-2.056 -2.447,-3.34c0.248,-1.285 0.809,-3.1 4.711,-4.711c3.903,-1.611 7.543,-1.757 7.543,-1.757l0.131,-1.758c0,0 -8.969,-1.356 -13.707,0.327c-4.738,1.684 -10.097,8.02 -10.097,8.02c0,0 0.935,3.064 -0.667,4.666c-1.601,1.601 -3.754,-0.245 -3.754,-0.245l-2.456,3.118l6.197,6.197l3.112,-2.461c0,0 -1.472,-2.207 -0.017,-3.528c3.132,-2.842 6.145,0.777 6.145,0.777Z"/>
                        </svg>
                    </div>
                    <div>
                        常用工具
                    </div>
                </a>
            </li>

            {% if errata_page_visible %}
                <li>
                    <a href="{% url 'errata' %}">
                        <div>
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0" y="0" viewBox="0 0 200 200" enable-background="new 0 0 200 200" xml:space="preserve">
                                <path d="M120,30 L50,30 A20,20,0,0,0,30,50 L30,150 A20,20,0,0,0,50,170 L150,170 A20,20,0,0,0,170,150 L170,80 
                                         L160,80 L160,150 A10,10,0,0,1,150,160 L50,160 A10,10,0,0,1,40,150 L40,50 A10,10,0,0,1,50,40 L120,40
                                         M160,15 A25,25,0,1,0,160,65 A25,25,0,1,0,160,15 L160,25 A15,15,0,1,1,160,55 A15,15,0,1,1,160,25">
                                </path>
                            </svg>
                        </div>
                        <div>
                            更新公告
                        </div>
                    </a>
                </li>
            {% endif %}

        </ul>
    </div>




    <!-- TODO: review message part -->
    <script>
    {% if team %}
        openSocket('/ws/team', showNotify);
    {% endif %}
    {% if messages %}
    {% for message in messages %}
        {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
        toastr.error("{{ message|escapejs }}");
        {% elif message.level == DEFAULT_MESSAGE_LEVELS.WARNING %}
        toastr.warning("{{ message|escapejs }}");
        {% elif message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}
        toastr.success("{{ message|escapejs }}");
        {% else %}
        showNotify("{{ message|escapejs }}");
        {% endif %}
    {% endfor %}
    {% endif %}
    </script>

    {% block content_nowrap %}


    <div class="content">
        {% if request.user.is_authenticated %}
            {% if is_superuser %}
                <button id="toggle-shortcuts" aria-expanded="false" aria-controls="shortcuts" title="管理工具">
                    {% if not hunt_is_prereleased %}&#x26A0;&#xFE0F;{% endif %}
                    管理&#x25BC;
                </button>
                {% if unclaimed_hints %}
                    <a class="current-stat" title="积压提示： {{ unclaimed_hints }}" href="{% url 'hint-list' %}" style="color: red">
                        {% include 'icon-hint.svg' %}
                        <span class="current-stat-label">{{ unclaimed_hints }}</span>
                    </a>
                {% endif %}
                <div class="shortcuts" id="shortcuts">
                    <form method="post" action="{% url 'shortcuts' %}" target="dummy">
                        {% csrf_token %}
                        {% if not hunt_is_prereleased %}
                        <p>
                            {% translate "Even though you&rsquo;re an admin, you&rsquo;re not currently marked as a testsolver, so you won&rsquo;t be able to view puzzles." %}
                        </p>
                        {% endif %}
                        {% for shortcut in shortcuts %}
                        {% if 'action' in shortcut %}
                        <button class="btn{% if shortcut.danger %} danger{% endif %}" type="submit" name="action" value="{{ shortcut.action }}">{{ shortcut.name }}</button>
                        {% else %}
                        <div>{{ shortcut.name }}</div>
                        {% endif %}
                        {% endfor %}
                        {% if puzzle %}
                        <div>本题答案</div>
                        <div class="spoiler">{{ puzzle.answer }}</div>
                        <div>{{ puzzle.round.name }} #{{ puzzle.order }}</div>
                        <a href="/admin/puzzles/puzzle/{{ puzzle.id }}/change/" class="btn">进入后台修改本题</a>
                        <a href="{% url 'survey' puzzle.slug %}" class="btn">调查统计</a>
                        <input name="puzzle" value="{{ puzzle.slug }}" type="hidden">
                        {% endif %}

                        {% if view_team %}
                        <div>本队伍</div>
                        <div style="font-size: 70%">
                        testsolver: {{view_team.is_prerelease_testsolver}} | time from start: {{view_team.time_since_start}}
                        </div>
                        <a href="/admin/puzzles/team/{{ view_team.id }}/change/" class="btn">进入后台修改本题</a>
                        <a href="{% url 'impersonate-start' view_team.user_id %}" class="btn danger">顶号（慎用！）</a>
                        <div></div>
                        <a href="/admin/puzzles/answersubmission/?team__id__exact={{ view_team.id }}" class="btn">提交历史</a>
                        <a href="{% url 'hint-list' %}?team={{ view_team.id }}" class="btn">全部提示</a>
                        {% endif %}
                        <div>{% translate "Download logs" %}</div>
                        <a class="btn" href="{% url 'guess-csv' %}">所有提交</a>
                        <a class="btn" href="{% url 'hint-csv' %}">所有提示</a>
                        <a class="btn" href="{% url 'puzzle-log' %}">所有本题日志</a>
                        <iframe src="about:blank" name="dummy" style="display: none"></iframe>
                    </form>
                </div>
                <script>
                    const downArrow = "\u25BC";
                    const upArrow = "\u25B2";
                    const toggleButton = document.getElementById("toggle-shortcuts");
                    const buttonTextPrefix = toggleButton.innerText.substring(0, toggleButton.innerText.length-1);
                    const shortcutsPopup = document.getElementById("shortcuts");
                    toggleButton.addEventListener("click", () => {
                        if (toggleButton.innerText.endsWith(downArrow)) {
                            toggleButton.innerText = buttonTextPrefix + upArrow;
                            toggleButton.ariaExpanded = true;
                            shortcutsPopup.style.display = "block";
                        } else {
                            toggleButton.innerText = buttonTextPrefix + downArrow;
                            toggleButton.ariaExpanded = false;
                            shortcutsPopup.style.display = "none";
                        }
                    })
                </script>
            {% endif %}
        {% endif %}

        <div class="top-more-actions">
            {% block top-left-actions %}{% endblock %}
        </div>
        {% block content %}{% endblock %}
    </div>
    {% endblock %}

    <!-- <script>
        const skipToMainLink = document.querySelector("a.skip-to-main");
        const mainContentElement = document.getElementsByTagName("main")?.item(0) || document.querySelector("div.content");
        if (skipToMainLink && mainContentElement) {
            const mainContentAnchor = document.createElement("a");
            const anchorId = "main-content-anchor"
            mainContentAnchor.className = anchorId;
            mainContentAnchor.id = anchorId;
            skipToMainLink.href = `#${anchorId}`;
            mainContentElement.parentNode.insertBefore(mainContentAnchor, mainContentElement);
        }
    </script> -->
    
    <!-- <footer>
        {% translate 'Powered by <a href="https://github.com/galacticpuzzlehunt/gph-site">gph-site</a>' %}
    </footer> -->
</body>
</html>
